plugins {
    id 'kotlin-multiplatform' version '1.3.10'
}

repositories {
    mavenCentral()
}


kotlin {
    targets {
        fromPreset(presets.macosX64, 'LambdaRuntime')
        fromPreset(presets.linuxX64, 'LambdaRuntimeLinux')
        configure([LambdaRuntime]) {
            compilations.main.outputKinds 'EXECUTABLE'
            compilations.main.entryPoint 'runtime.main'
            compilations.main.cinterops {
                libcurl {
                    extraOpts '-I/src/main/c_interop'
                }
                jansson {
                    extraOpts '-I/src/main/c_interop'
                }
            }
        }
        configure([LambdaRuntimeLinux]) {
            compilations.main.outputKinds 'EXECUTABLE'
            compilations.main.entryPoint 'runtime.main'
            compilations.main.cinterops {
                libcurl {
                    extraOpts '-I/src/main/c_interop'
                }
                jansson {
                    extraOpts '-I/src/main/c_interop'
                }
            }
        }
    }
}

task runProgram {
    def buildType = 'debug' // Change to 'debug' to run application with debug symbols.
    dependsOn "build"
    doLast {
        def programFile = "build/exe/main/${buildType}/macos_x64/lambda-runtime-kotlin-native.kexe"
        exec {
            executable programFile
            args ''
        }
    }
}